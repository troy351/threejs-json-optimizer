<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Optimizer</title>
    <style>
        img {
            width: 30%;
            border: 1px solid red
        }
    </style>
</head>
<body>
<div>three.js json optimizer</div>
<div>please choose app.json below</div>
<input type="file" id="fileInput">
<script>
    window.onload = function () {
        document.getElementById('fileInput').addEventListener("input", (e) => {
            const file = e.target.files[0]
            if (!file) {
                alert('please choose a file')
                return
            }

            if (file.type !== 'application/json') {
                alert('please choose a json file')
                return
            }

            const reader = new FileReader()

            reader.onload = function () {
                converter(JSON.parse(this.result))
            }

            reader.readAsText(file)
        })


        const uuidReplaceMap = new Map()
        const uuidMap = new Map()
        const UUID_LENGTH = 36
        let json

        async function converter(jsonObj) {
            if (!jsonObj.metadata) {
                alert('not a valid three.js data file')
                return
            }

            json = jsonObj

            // remove scripts
            json.scripts = {}

            await convertPngToJpg(json)

            await resizeImages(json)



            removeDuplicateImages(json)

            removeDuplicateTextures(json)

            removeDuplicateMaterials(json)

            removeDuplicateGeometries(json)


            console.log('optimizing object')
            reattachObjectUUID(json.scene.object)

            removeUnused(json)

            // listJPG(json)

            exportJSON(json)
        }


        function convertPngToJpg(json) {
            console.log('checking image format')

            const imgList = json.scene.images

            return new Promise((resolve) => {
                let count = 0, progress = 0

                imgList.forEach(item => {
                    const url = item.url

                    // skip jpg
                    if (url.startsWith("data:image/jpeg")) return

                    count++
                    const img = new Image()
                    img.src = url


                    img.onload = function () {
                        const canvas = document.createElement("canvas")
                        canvas.width = img.width
                        canvas.height = img.height
                        const ctx = canvas.getContext("2d")
                        ctx.drawImage(img, 0, 0)

                        item.url = canvas.toDataURL("image/jpeg", 0.6)
                        progress++

                        if (count === progress) {
                            resolve()
                        }
                    }
                })

                if (!count) {
                    console.log('there is no png image, no need to convert')
                    resolve()
                }
            })
        }

        function resizeImages(json) {
            console.log('resizing images')
            const imgList = json.scene.images

            return new Promise((resolve) => {
                let progress = 0
                imgList.forEach(item => {
                    const url = item.url

                    const img = new Image()
                    img.src = url

                    img.onload = function () {
                        const log2 = Math.log2(img.width)

                        if (Math.floor(log2) === log2 && log2 <= 11) {
                            progress++
                            if (imgList.length === progress) resolve()
                            return
                        }

                        const size = Math.min(2 ** Math.round(log2), 2048)

                        console.log(`resizing image ${item.uuid} from ${img.width}x${img.width} to ${size}x${size}`)

                        const canvas = document.createElement("canvas")
                        canvas.width = size
                        canvas.height = size

                        const ctx = canvas.getContext("2d")
                        ctx.drawImage(img, 0, 0, size, size)

                        item.url = canvas.toDataURL("image/jpeg", 0.6)
                        progress++

                        if (imgList.length === progress) resolve()
                    }
                })
            })
        }

        function listJPG(json) {
            const imgList = json.scene.images


            imgList.forEach(item => {
                const url = item.url

                const img = new Image()
                img.src = url

                const div = document.createElement('div')
                const span = document.createElement('span')
                span.textContent = url.length + ' ' + item.uuid
                div.appendChild(img)
                div.appendChild(span)

                document.body.appendChild(div)
            })
        }

        function removeDuplicateImages(json) {
            console.log('removing duplicate images')
            const imgList = json.scene.images

            imgList.sort((a, b) => a.url.length - b.url.length)

            removeDuplicate(imgList, img => img.url.length)
        }

        function removeDuplicateTextures(json) {
            console.log('removing duplicate textures')

            const textures = json.scene.textures

            // set replace image
            textures.forEach(texture => {
                const image = uuidReplaceMap.get(texture.image)
                if (image) texture.image = image
            })

            attachJSONAndSort(textures)

            removeDuplicate(textures, texture => texture.json)

            removeAttachedJSON(textures)
        }

        function removeDuplicateMaterials(json) {
            console.log('removing duplicate materials')

            const materials = json.scene.materials

            // replace different map type
            materials.forEach(material => {
                Object.entries(material).forEach(([key, val]) => {
                    if (typeof val === 'string' && uuidReplaceMap.has(val)) {
                        material[key] = uuidReplaceMap.get(val)
                    }
                })
            })

            attachJSONAndSort(materials)

            removeDuplicate(materials, texture => texture.json)

            removeAttachedJSON(materials)
        }

        function removeDuplicateGeometries(json) {
            console.log('removing duplicate geometries')

            const geometries = json.scene.geometries


            attachJSONAndSort(geometries)

            removeDuplicate(geometries, texture => texture.json)

            removeAttachedJSON(geometries)
        }

        function reattachObjectUUID(obj) {
            Object.entries(obj).forEach(([key, value]) => {
                // if children, recursive
                if (key === 'children' && Array.isArray(value)) {
                    value.forEach(val => reattachObjectUUID(val))
                    return
                }

                // replace if its uuid
                if (typeof value === 'string' && value.length === UUID_LENGTH) {
                    obj[key] = uuidReplaceMap.get(value) || value
                }
            })
        }

        function collectAllUUID(json) {
            if (typeof json !== 'object') return

            if (json.uuid) uuidMap.set(json.uuid, json)

            const arr = Array.isArray(json) ? json : Object.values(json)

            arr.forEach(val => collectAllUUID(val))
        }

        function removeDuplicate(arr, getValue) {
            let i = 1
            while (i < arr.length) {
                if (getValue(arr[i]) !== getValue(arr[i - 1])) {
                    i++
                    continue
                }

                uuidReplaceMap.set(arr[i].uuid, arr[i - 1].uuid)

                arr.splice(i, 1)
            }
        }

        function attachJSONAndSort(arr) {
            arr.forEach(item => {
                const clone = {...item}

                // remove uuid and name which is not relevant
                delete clone.uuid
                delete clone.name

                item.json = JSON.stringify(clone)
            })

            arr.sort((a, b) => {
                if (a.json < b.json) return -1
                if (a.json > b.json) return 1
                return 0
            })
        }

        function removeAttachedJSON(arr) {
            arr.forEach(item => delete item.json)
        }

        function findUUIDUsage(str) {
            if (!uuidMap.size) collectAllUUID(json)

            uuidMap.forEach(val => {
                const vals = Object.values(val)
                const obj = vals.find(item => item.toString().includes(str))
                if (obj) console.log(val)
            })
        }

        function removeUnused(json) {
            const scene = json.scene

            const map = {}

            function collectUUID(obj) {
                Object.entries(obj).forEach(([key, value]) => {
                    // if children, recursive
                    if (key === 'children' && Array.isArray(value)) {
                        value.forEach(val => collectUUID(val))
                        return
                    }

                    // replace if its uuid
                    if (typeof value === 'string' && value.length === UUID_LENGTH) {
                        map[value] = true
                    }
                })
            }

            collectUUID(scene.object)

            scene.geometries = scene.geometries.filter(geo => map[geo.uuid])
            scene.geometries.forEach(geo => map[geo.uuid] = true)

            scene.materials = scene.materials.filter(mat => map[mat.uuid])
            scene.materials.forEach(material => Object.entries(material).forEach(([key, val]) => {
                if (typeof val === 'string' && val.length === UUID_LENGTH) map[val] = true
            }))

            scene.textures = scene.textures.filter(text => map[text.uuid])
            scene.textures.forEach(text => map[text.image] = true)

            scene.images = scene.images.filter(img => map[img.uuid])
        }

        function exportJSON(json) {
            console.log(json)
            const a = document.createElement('a')
            const blob = new Blob([JSON.stringify(json)])

            a.download = 'app-convert.json'

            a.href = URL.createObjectURL(blob)
            a.click()
        }
    }
</script>
</body>
</html>
